pipeline {
  agent any

  parameters {
    string(
      name: 'USER_REPO_URL',
      defaultValue: '',
      description: 'Git URL of the spoke repo (e.g., https://github.com/org/team-repo.git)'
    )
    string(
      name: 'USER_REPO_BRANCH',
      defaultValue: 'main',
      description: 'Branch to checkout from spoke repo'
    )
    choice(
      name: 'ENV',
      choices: ['dev', 'stage', 'prod'],
      description: 'Target environment'
    )
    string(
      name: 'TRIGGERING_USER',
      defaultValue: '',
      description: 'User id (mock AD principal or Jenkins user)'
    )
  }

  environment {
    SHARED_DAG_DIR = '/shared/airflow_dags'
    SPOKE_DIR      = 'spoke_repo'
  }

  stages {
    stage('Checkout Platform Repo') {
      steps {
        checkout scm
      }
    }

    stage('Auth: AD Groups via Python') {
      steps {
        sh """
          echo "Running authz.py for user=${TRIGGERING_USER}, env=${ENV}"
          python3 scripts/authz.py \\
            --env ${ENV} \\
            --user ${TRIGGERING_USER} \\
            --action deploy_dag \\
            --base-dir .
        """
      }
    }

    stage('Checkout Spoke Repo') {
      steps {
        sh """
          if [ -z "${USER_REPO_URL}" ]; then
            echo "USER_REPO_URL is required"
            exit 1
          fi

          echo "Cloning spoke repo ${USER_REPO_URL} (branch ${USER_REPO_BRANCH})"
          rm -rf ${SPOKE_DIR}
          git clone --branch ${USER_REPO_BRANCH} ${USER_REPO_URL} ${SPOKE_DIR}
        """
      }
    }

    stage('Validate project.json & DAG structure') {
      steps {
        sh """
          echo "Validating project.json and DAG layout for env ${ENV}"
          python3 scripts/validate_project.py --env ${ENV} --spoke-dir ${SPOKE_DIR}
        """
      }
    }

    stage('Deploy DAGs to Airflow') {
      steps {
        script {
          def manifestText = readFile("${SPOKE_DIR}/project.json")
          def manifest = readJSON(text: manifestText)
          def projectName = manifest.project_name
          def dagPath = manifest.dag_path

          sh """
            echo "Deploying DAGs for project ${projectName} to Airflow env ${ENV}"
            SRC_DAG_DIR=${SPOKE_DIR}/${dagPath}
            DEST_DAG_DIR=${SHARED_DAG_DIR}/${ENV}/${projectName}

            mkdir -p ${DEST_DAG_DIR}
            cp -r ${SRC_DAG_DIR}/*.py ${DEST_DAG_DIR}/

            echo "Files now in ${DEST_DAG_DIR}:"
            ls -R ${DEST_DAG_DIR}
          """
        }
      }
    }
  }

  post {
    success {
      echo "DAG deployment successful for ${ENV} from ${USER_REPO_URL}"
    }
    failure {
      echo "DAG deployment FAILED for ${ENV} from ${USER_REPO_URL}"
    }
  }
}