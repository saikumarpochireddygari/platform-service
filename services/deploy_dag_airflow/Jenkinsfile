pipeline {
  agent any

  parameters {
    string(
      name: 'USER_REPO_URL',
      defaultValue: '',
      description: 'Git URL of the spoke repo (e.g., https://github.com/org/team-repo.git)'
    )
    string(
      name: 'USER_REPO_BRANCH',
      defaultValue: 'main',
      description: 'Branch to checkout from spoke repo'
    )
    choice(
      name: 'ENV',
      choices: ['dev', 'stage', 'prod'],
      description: 'Target environment'
    )
    string(
      name: 'TRIGGERING_USER',
      defaultValue: 'alice',
      description: 'User id (mock AD principal or Jenkins user)'
    )
  }

  environment {
    SHARED_DAG_DIR = "/workspace/airflow/dags"
    SPOKE_DIR      = 'spoke_repo'
  }

  stages {
    stage('Checkout Platform Repo') {
      steps {
        checkout scm
      }
    }

    stage('Auth: AD Groups via Python') {
      steps {
        sh """
          echo "Running authz.py for user=${params.TRIGGERING_USER}, env=${params.ENV}"
          python3 scripts/authz.py \\
            --env ${params.ENV} \\
            --user ${params.TRIGGERING_USER} \\
            --action deploy_dag \\
            --base-dir .
        """
      }
    }

    stage('Checkout Spoke Repo') {
      steps {
        script {
          if (!params.USER_REPO_URL?.trim()) {
            error "USER_REPO_URL is required"
          }
        }
        sh """
          echo "Cloning spoke repo ${params.USER_REPO_URL} (branch ${params.USER_REPO_BRANCH})"
          rm -rf ${env.SPOKE_DIR}
          git clone --branch ${params.USER_REPO_BRANCH} ${params.USER_REPO_URL} ${env.SPOKE_DIR}
        """
      }
    }

    stage('Validate project.json & DAG structure') {
      steps {
        sh """
          echo "Validating project.json and DAG layout for env ${params.ENV}"
          python3 scripts/validate_project.py --env ${params.ENV} --spoke-dir ${env.SPOKE_DIR}
        """
      }
    }

    stage('Debug workspace paths') {
  steps {
    sh """
      set -eux
      echo "WORKSPACE=$WORKSPACE"
      echo "PWD=$(pwd)"
      echo "Listing repo airflow folder:"
      ls -la "${WORKSPACE}/airflow" || true
      ls -la "${WORKSPACE}/airflow/dags" || true
    """
  }
}

    stage('Deploy DAGs to Airflow') {
  steps {
    script {
      def manifestText = readFile("${env.SPOKE_DIR}/project.json")
      def manifest     = readJSON(text: manifestText)

      def projectName = manifest.project_name
      def dagPath     = manifest.dag_path

      if (!projectName) error "project_name is missing in project.json"
      if (!dagPath)     error "dag_path is missing in project.json"

      def srcDagDir  = "${env.SPOKE_DIR}/${dagPath}"
      def destDagDir = "${env.AIRFLOW_DAGS_DIR}/${params.ENV}/${projectName}"

      echo "Source: ${srcDagDir}"
      echo "Dest:   ${destDagDir}"

      sh """
        set -eux
        mkdir -p '${destDagDir}'
        ls -la '${srcDagDir}' || true
        cp -v '${srcDagDir}'/*.py '${destDagDir}/'
        echo "Deployed files:"
        ls -la '${destDagDir}'
      """
    }
  }
}
    stage('Debug: show deployed DAGs (bind mount)') {
  steps {
    sh """
      set -eux
      echo "Listing /workspace/airflow/dags:"
      ls -R /workspace/airflow/dags || true
    """
  }
}

  }

  post {
    success {
      echo "DAG deployment successful for ${params.ENV} from ${params.USER_REPO_URL}"
    }
    failure {
      echo "DAG deployment FAILED for ${params.ENV} from ${params.USER_REPO_URL}"
    }
  }
}