pipeline {
  agent any

  parameters {
    string(
      name: 'USER_REPO_URL',
      defaultValue: '',
      description: 'Git URL of the spoke repo (e.g., https://github.com/org/team-repo.git)'
    )
    string(
      name: 'USER_REPO_BRANCH',
      defaultValue: 'main',
      description: 'Branch to checkout from spoke repo'
    )
    choice(
      name: 'ENV',
      choices: ['dev', 'stage', 'prod'],
      description: 'Target environment'
    )
    string(
      name: 'TRIGGERING_USER',
      defaultValue: 'alice',
      description: 'User id (mock AD principal or Jenkins user)'
    )
  }

  environment {
    SHARED_DAG_DIR = '/shared/airflow_dags'
    SPOKE_DIR      = 'spoke_repo'
  }

  stages {
    stage('Checkout Platform Repo') {
      steps {
        checkout scm
      }
    }

    stage('Auth: AD Groups via Python') {
      steps {
        sh """
          echo "Running authz.py for user=${params.TRIGGERING_USER}, env=${params.ENV}"
          python3 scripts/authz.py \\
            --env ${params.ENV} \\
            --user ${params.TRIGGERING_USER} \\
            --action deploy_dag \\
            --base-dir .
        """
      }
    }

    stage('Checkout Spoke Repo') {
      steps {
        script {
          if (!params.USER_REPO_URL?.trim()) {
            error "USER_REPO_URL is required"
          }
        }
        sh """
          echo "Cloning spoke repo ${params.USER_REPO_URL} (branch ${params.USER_REPO_BRANCH})"
          rm -rf ${env.SPOKE_DIR}
          git clone --branch ${params.USER_REPO_BRANCH} ${params.USER_REPO_URL} ${env.SPOKE_DIR}
        """
      }
    }

    stage('Validate project.json & DAG structure') {
      steps {
        sh """
          echo "Validating project.json and DAG layout for env ${params.ENV}"
          python3 scripts/validate_project.py --env ${params.ENV} --spoke-dir ${env.SPOKE_DIR}
        """
      }
    }

    stage('Deploy DAGs to Airflow') {
      steps {
        script {
          // Read project.json from the spoke repo
          def manifestText = readFile("${env.SPOKE_DIR}/project.json")
          def manifest     = readJSON(text: manifestText)

          def projectName = manifest.project_name
          def dagPath     = manifest.dag_path

          if (!projectName) {
            error "project_name is missing in project.json"
          }
          if (!dagPath) {
            error "dag_path is missing in project.json"
          }

          // Build source & destination DAG dirs
          def srcDagDir  = "${env.SPOKE_DIR}/${dagPath}"
          def destDagDir = "${env.SHARED_DAG_DIR}/${params.ENV}/${projectName}"

          echo "Deploying DAGs for project ${projectName}"
          echo "Source DAG dir: ${srcDagDir}"
          echo "Destination DAG dir: ${destDagDir}"

          sh """
            mkdir -p '${destDagDir}'
            cp -r '${srcDagDir}'/*.py '${destDagDir}/'

            echo "Files now in ${destDagDir}:"
            ls -R '${destDagDir}'
          """
        }
      }
    }
  }

  post {
    success {
      echo "DAG deployment successful for ${params.ENV} from ${params.USER_REPO_URL}"
    }
    failure {
      echo "DAG deployment FAILED for ${params.ENV} from ${params.USER_REPO_URL}"
    }
  }
}